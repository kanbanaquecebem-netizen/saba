<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>SABA</title>
<style>
/* ============================= ESTILO GERAL ============================= */
body {
    font-family: Arial, sans-serif;
    background: rgb(255, 255, 255);
    margin: 0;
    padding: 0;
    color: #fff;
}
/* ============================= CABEÇALHO ============================= */
header {
    background: rgb(255, 255, 255);
    color: rgb(255, 255, 255);
    padding: 8px 0;
    text-align: center;
    font-size: 34px;
    font-weight: bold;
    position: relative;
    border-bottom: 3px solid rgb(255, 136, 0);
}
#relogio {
    font-size: 15px;
    font-weight: bold;
    margin-top: 5px;
    color: #353d61;
}
/* Botões do cabeçalho */
.header-buttons-left {
    position: absolute;
    top: 10px;
    left: 20px;
    display: flex;
    gap: 12px;
}
#btnCadastro, #btnMenuAcoes {
    padding: 12px 20px;
    border-radius: 8px;
    font-size: 16px;
    font-weight: bold;
    border: 3px solid #353d61;
    cursor: pointer;
}
#btnCadastro {
    background: #353d61;
    color: #ffffff;
}
#btnMenuAcoes {
    width: auto;
    min-width: 52px;
    background: rgb(255, 255, 255);
    color: #353d61;
    font-size: 24px;
    line-height: 1;
    padding: 8px 14px;
}
.submenu-acoes {
    position: absolute;
    top: 58px;
    left: 0;
    background: #fff;
    border: 2px solid #353d61;
    border-radius: 10px;
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.18);
    min-width: 220px;
    z-index: 1300;
    padding: 6px;
}
.submenu-acoes button {
    width: 100%;
    margin: 0 0 6px 0;
    padding: 10px 12px;
    border-radius: 8px;
    border: 2px solid #d8dbe8;
    background: #ffffff;
    color: #1f2747;
    text-align: left;
    font-size: 15px;
}
.submenu-acoes button:last-child { margin-bottom: 0; }
.submenu-acoes button:hover {
    background: #353d61;
    color: #ffffff;
    border-color: #353d61;
}
.header-buttons-right {
    position: absolute;
    top: 10px;
    right: 20px;
    display: flex;
    align-items: center;
    gap: 12px;
}
#btnHistorico {
    padding: 12px 20px;
    border-radius: 8px;
    font-size: 16px;
    font-weight: bold;
    background: rgba(255, 255, 255, 0.89);
    color: #353d61;
    border: 3px solid #353d61;
    cursor: pointer;
}
/* ============================= PESQUISA MINIMALISTA (NOVA) ============================= */
#pesquisaOSPV {
    padding: 12px 20px;
    width: 190px;
    border-radius: 10px;
    border: 3px solid #353d61;
    font-size: 20px;
    outline: none;
}
#btnPesquisar {
    padding: 12px 20px;
    background: #353d61;
    color: white;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-size: 20px;
    font-weight: bold;
}
/* ============================= CONTEÚDO ============================= */
.container {
    display: flex;
    flex-wrap: wrap;
    margin: 15px auto;
    max-width: 100%;
    height: calc(100vh - 140px);
    gap: 10px;
}
.coluna {
    flex: 1;
    min-width: 20px;
    margin: 0 10px;
    background: rgba(255, 136, 0, 0.925);
    border-radius: 15px;
    padding: 20px;
    display: flex;
    flex-direction: column;
    overflow-y: auto;
    height: 100%;
    border: 3px solid rgb(53, 61, 77);
}
.coluna h2 {
    text-align: center;
    font-size: 28px;
    color: rgb(53, 61, 77);
    font-weight: bold;
}
/* ============================= CARDS - CORES EXATAS COMO PEDIDO ============================= */
.card {
    border-radius: 12px;
    padding: 8px 20px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    text-align: center;
    font-weight: bold;
    font-size: 15px;
    min-width: 15px;
    max-width: 240px;
    cursor: pointer;
    transition: transform 0.2s, opacity 0.3s ease;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    margin: 6px auto;
    position: relative;
}

.card:hover {
    transform: translateY(-5px);
}

/* Impressão = vermelho */
.impressao-card {
    background: #ff0000 !important;
    color: #fff !important;
}

/* Em Separação = amarelo */
.separacao-card {
    background: #ffc800 !important;
    color: #000 !important;
}

/* Aguardando Retirada: OS = azul claro, PV = azul escuro */
.aguardando-os {
    background: #369aff !important;
    color: #000 !important;
}
.aguardando-pv {
    background: #003087 !important;
    color: #fff !important;
}

/* Finalizados = verde */
.finalizado-card {
    background: #008a2e !important;
    color: #fff !important;
}

/* Impressão e Finalizados: largura total */
#impressao .card, #finalizados .card {
    min-width: 40px;
    max-width: 335px;
    width: 100%;
    margin: 5px 0;
}

/* Inputs */
input, select, textarea {
   width: 100%;
    padding: 16px 12px; /* Aumenta o padding (mais alto e confortável) */
    margin: 12px 0;
    border-radius: 10px; /* Bordas mais arredondadas */
    border: 2px solid #b8b5b5;
    font-size: 18px; /* Fonte maior para facilitar digitação */
    box-sizing: border-box;
}
textarea {
    resize: vertical;
    min-height: 120px;
}
button {
    width: 100%;
    padding: 12px;
    border-radius: 6px;
    margin-top: 8px;
    font-size: 16px;
    font-weight: bold;
    background: darkblue;
    color: #fff;
    border: none;
}
button:disabled { background: #888; }
.senha-card {
    border: 2px solid #e7e9f3;
    border-radius: 14px;
    padding: 16px;
    background: linear-gradient(180deg, #f8f9ff 0%, #ffffff 100%);
}
.senha-icon {
    width: 44px;
    height: 44px;
    border-radius: 12px;
    background: #353d61;
    color: #fff;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 14px;
    font-weight: bold;
    margin-bottom: 10px;
}
#senhaLabel {
    display: block;
    font-weight: bold;
    color: #1f2747;
}
.senha-hint {
    display: block;
    color: #55608f;
    margin-top: 4px;
}
.senha-input {
    text-align: center;
    letter-spacing: 8px;
    font-size: 28px;
    font-weight: bold;
    border: 2px solid #b8c0e3;
    background: #fff;
}
.senha-input:focus {
    border-color: #353d61;
    outline: none;
    box-shadow: 0 0 0 3px rgba(53,61,97,0.15);
}
/* Modal */
.modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.7);
    display: flex;
    justify-content: center;
    align-items: center;
    visibility: hidden;
}
.modal-content {
    background: #fff;
    color: #000;
    padding: 25px;
    border-radius: 15px;
    width: 85%;
    max-width: 620px;
    max-height: 92vh;
    overflow-y: auto;
    font-size: 16px;
    pointer-events: auto;
    box-sizing: border-box;
}
.hidden { display: none !important; }
.finalizado-expandido {
    width: 100%;
    font-size: 16px;
}

/* ============================= HISTÓRICO TIPO EXCEL ============================= */
#listaHistorico {
    width: 100%;
    max-height: 50vh;
    overflow-y: auto;  /* IMPORTANTE: auto ou scroll */
    border: 2px solid darkblue;
    border-radius: 10px;
    background: #fff;
    color: #000;

    scrollbar-width: none;        /* Firefox */
    -ms-overflow-style: none;     /* IE/Edge antigo */
}

#listaHistorico::-webkit-scrollbar {
    display: none;                /* Chrome, Safari, Edge */
}
.tabela-historico {
    display: grid;
    grid-template-columns: 80px 100px 1fr 150px;
    gap: 0;
    font-size: 15px;
}

.tabela-cabecalho {
    display: contents;
}

.tabela-cabecalho > div {
    background: darkblue;
    color: white;
    font-weight: bold;
    padding: 10px;
    text-align: center;
    position: sticky;
    top: 0;
    z-index: 500;
    border-bottom: 3px solid orange;
}

.tabela-linha {
    display: contents;
}

.tabela-linha > div {
    padding: 10px;
    border-bottom: 1px solid #ddd;
    text-align: center;
}

.tabela-linha:nth-child(even) > div {
    background: #f5f5f5;
}

.tabela-linha:nth-child(odd) > div {
    background: #fff;
}

.tabela-detalhes {
    grid-column: 1 / -1;
    padding: 8px 20px;
    font-size: 13px;
    color: #555;
    background: #f9f9f9;
    border-bottom: 1px solid #ddd;
    text-align: left;
}
/* Esconde o scroll da página inteira, mas mantém o scroll nas colunas */
body {
    overflow: hidden; /* Esconde o scroll do body */
}

/* Versão corrigida da que você gostou: esconde scroll, mantém rolagem, permite ver o final, sem terceira coluna fantasma */
.coluna {
    overflow-y: auto; /* Scroll nas colunas */
    height: calc(100vh - 140px);
    scrollbar-width: none; /* Firefox */
    -ms-overflow-style: none; /* IE/Edge */
}

.coluna::-webkit-scrollbar {
    display: none; /* Chrome/Safari/Edge */
}

/* Container interno flex com wrap, centralizado e sem coluna fantasma */
#em_separacao,
#aguardando_retirada {
    display: flex;
    flex-wrap: wrap;
    justify-content: center; /* centraliza os cards e evita espaço extra */
    align-content: flex-start; /* evita linha vazia no final */
    gap: 15px; /* espaçamento uniforme */
    padding: 10px;
}

/* Cards compactos, tamanho fixo para não criar espaço extra */
.card {
    flex: 0 0 120px; /* tamanho fixo compacto, não estica */
    margin: 0;
}

/* Garante que o conteúdo role até o final sem corte */
.coluna > div {
    min-height: 100%;
}
/* Scroll das colunas só quando precisar - escondido quando couber tudo */
.coluna {
    overflow-y: auto; /* scroll só quando necessário */
    height: calc(100vh - 140px);
}

/* Esconde completamente a barra de scroll (todas as colunas) */
.coluna {
    scrollbar-width: none; /* Firefox - esconde barra */
    -ms-overflow-style: none; /* IE/Edge - esconde barra */
}

.coluna::-webkit-scrollbar {
    display: none; /* Chrome/Safari - esconde barra permanentemente */
}

/* Garante que a rolagem funcione mesmo sem barra visível */
.coluna > div {
    min-height: 100%;
}

/* Cabeçalhos das colunas por cima de TUDO */
/* Fundo do modal com z-index baixo (para não cobrir os cabeçalhos) */
.modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.7);
    display: flex;
    justify-content: center;
    align-items: center;
    visibility: hidden;
    z-index: 1001; /* baixo para o fundo não cobrir os cabeçalhos */
    pointer-events: none; /* permite clicar através do fundo */
}

/* Conteúdo do modal por cima do fundo, mas abaixo dos cabeçalhos */
.modal-content {
    pointer-events: auto; /* só o conteúdo é clicável */
    z-index: 401;
    background: #fff;
    color: #000;
    padding: 25px;
    border-radius: 15px;
    width: 85%;
    max-width: 620px;
    max-height: 92vh;
    overflow-y: auto;
}

/* Cabeçalhos das colunas por cima de TUDO */
.coluna h2 {
    position: sticky;
    top: 0;
    z-index: 1000; /* altíssimo para ficar por cima do modal */
    background: rgba(255, 136, 0, 0);
    margin: 0;
    padding: 15px;
    border-radius: 10px 10px 0 0;

}

/* Adição mínima para o contador */
.contador {
    font-size: 0.68em;
    color: #444;
    background: rgba(255,255,255,0.8);
    padding: 2px 8px;
    border-radius: 10px;
    margin-left: 10px;
    font-weight: normal;
    vertical-align: middle;
}

/* Animação de piscar suave para cards com observação */
@keyframes piscarObservacao {
    0%   { box-shadow: 0 0 12px rgb(128, 0, 0); }
    50%  { box-shadow: 0 0 35px rgba(121, 0, 0, 0.9); }
    100% { box-shadow: 0 0 15px rgb(156, 0, 0); }
}

.card.tem-observacao {
    animation: piscarObservacao 1.0s infinite ease-in-out;
    border: 4px solid #ffffff;
    box-shadow: 0 0 15px rgba(255, 0, 0, 0.6);
}

/* Alerta de prazo (etiqueta vermelha + piscar) */
@keyframes piscarPrazo {
    0%   { box-shadow: 0 0 10px rgba(209, 0, 0, 0.6); }
    50%  { box-shadow: 0 0 26px rgba(209, 0, 0, 1); }
    100% { box-shadow: 0 0 10px rgba(209, 0, 0, 0.6); }
}

.card.prazo-alerta {
    animation: piscarPrazo 0.9s infinite ease-in-out;
}

.etiqueta-alerta {

.etiqueta-alerta.roxa {
    background: #6f2dbd;
}


    display: inline-block;
    background: #d10000;
    color: #fff;
    font-size: 11px;
    font-weight: bold;
    padding: 4px 8px;
    border-radius: 6px;
    margin: 2px 0 6px;
    letter-spacing: 0.3px;
}
/* Suaviza o aparecimento/desaparecimento dos cards na busca */
.card[style*="display: none"] {
    opacity: 0;
    transform: scale(0.92);
}

/* === ESTILO PARA BOTÕES NOVOS NO CABEÇALHO === */
#btnReentrar, #btnExportarAtual {
    background: #353d61;
    color: #ffffff;
    border: 3px solid #000000;
    padding: 12px 20px;
    border-radius: 8px;
    font-size: 16px;
    font-weight: bold;
    cursor: pointer;
}

#btnReentrar:hover, #btnExportarAtual:hover {
    background: #f0f8ff;
}

/* === ESTILO PARA CARDS REENTRADOS (DESTAQUE VISUAL) === */
.card.reentrado {
    border: 4px solid #dc3545 !important;
    box-shadow: 0 4px 20px rgba(220, 53, 69, 0.5) !important;
    position: relative;
}

.card.reentrado::before {
    content: "↺ REENTRADA";
    position: absolute;
    top: -14px;
    left: 12px;
    background: #000000;
    color: rgb(255, 136, 0);
    padding: 4px 10px;
    font-size: 11px;
    font-weight: bold;
    border-radius: 4px;
    z-index: 10;
    box-shadow: 0 2px 6px rgba(0,0,0,0.3);
}

/* === ESTILO PARA CAMPO MOTIVO REENTRADA === */
#motivoReentrada {
    background: #fff3cd !important;
    border: 2px solid #ffc107 !important;
    margin-top: 12px !important;
}

#avisoMotivoReentrada {
    color: #dc3545;
    font-weight: bold;
    margin-top: 6px;
    font-size: 14px;
    display: none;
}

#reentradaMotivoContainer label {
    color: #dc3545;
    font-weight: bold;
}
</style>
</head>
<body>
<header>
    <img src="logo.png.png" alt="Logo SABA" style="height: 100px; margin-bottom: -25px;">
    <div id="relogio"></div>
    <div id="contadorCards" style="font-size:14px; font-weight:bold; color:#353d61; margin-top:6px;">
    Total de cards: <span id="totalCards">0</span>
    </div>    
    <div class="header-buttons-left">
        <button id="btnCadastro" onclick="abrirCadastro()">Cadastrar</button>
        <button id="btnMenuAcoes" onclick="alternarMenuAcoes()" aria-label="Abrir menu de acoes">☰</button>
        <div id="submenuAcoes" class="submenu-acoes hidden">
            <button type="button" onclick="executarAcaoMenu(senhaCancelar)">Cancelar</button>
            <button type="button" onclick="executarAcaoMenu(abrirReentradaComSenha)">Reentrar OS/PV</button>
            <button type="button" onclick="executarAcaoMenu(abrirCadastroEquipe)">Equipe</button>
            <button type="button" onclick="executarAcaoMenu(exportarPedidosAtuaisCSV)">Exportar Atual (Excel)</button>
            <button type="button" onclick="executarAcaoMenu(abrirHistorico)">Historico</button>
            <button type="button" onclick="executarAcaoMenu(abrirDadosProducaoMenu)">Dados de Producao</button>
        </div>
    </div>
    <div class="header-buttons-right">
        <!-- PESQUISA MINIMALISTA AO LADO DO HISTÓRICO -->
        <input type="text" id="pesquisaOSPV" placeholder="Buscar OS/PV ou nome...">
        <button id="btnPesquisar" onclick="pesquisarPedido()">🔍</button>
    </div>
</header>
<div class="container">
    <div class="coluna">
        <h2>🖨️ Impressão<span class="contador" data-status="impressao">(0)</span></h2>
        <div id="impressao"></div>
    </div>
    <div class="coluna" id="em_separacao_container">
        <h2>📦 Em Separação<span class="contador" data-status="em_separacao">(0)</span></h2>
        <div id="em_separacao" style="display: flex; flex-wrap: wrap;"></div>
    </div>
    <div class="coluna" id="aguardando_retirada_container">
        <h2>📫 Aguardando Retirada<span class="contador" data-status="aguardando_retirada">(0)</span></h2>
        <div id="aguardando_retirada" style="display: flex; flex-wrap: wrap;"></div>
    </div>
    <div class="coluna">
        <h2>✅ Finalizados<span class="contador" data-status="finalizados">(0)</span></h2>
        <div id="finalizados"></div>
    </div>
</div>
<!-- Modal -->
<div id="modal" class="modal" onclick="fecharModal()">
    <div class="modal-content" onclick="event.stopPropagation()">
        <h3 id="modalTitulo"></h3>
        <p id="modalInfo"></p>
        <div id="campoSenha" class="hidden">
            <div class="senha-card">
                <div class="senha-icon">PIN</div>
                <label id="senhaLabel">Digite a senha:</label>
                <small id="senhaHint" class="senha-hint">Informe sua senha para continuar.</small>
                <input type="password" id="inputSenha" class="senha-input" inputmode="numeric" maxlength="4" placeholder="0000" autocomplete="off" oninput="validarSenha()">
                <button id="btnConfirmarSenha" disabled onclick="confirmarSenha()">Confirmar</button>
                <button onclick="fecharModal()" style="background:#ccc; margin-top:5px; color:#222;">Cancelar</button>
            </div>
        </div>
        <div id="campoCadastro" class="hidden">
            <label>Tipo:</label>
            <select id="tipo">
                <option value="OS">OS</option>
                <option value="PV">PV</option>
            </select>
            <label>Numero:</label>
            <input type="text" id="numero" inputmode="numeric" pattern="[0-9]*">
            <label>Nome Tecnico / Cliente:</label>
            <input type="text" id="nome">
            <label>Vendedor:</label>
            <input type="text" id="vendedor">
            <label>Data de Instalacao:</label>
            <input type="date" id="dataInstalacao">
            <select id="periodoInstalacao">
                <option value="">Selecione o periodo</option>
                <option value="Manha">Manha</option>
                <option value="Tarde">Tarde</option>
            </select>
            <label>Observacao:</label>
            <textarea id="observacao" rows="3" placeholder="Detalhes importantes, problemas informados, etc..."></textarea>
            <button onclick="cadastrar()">Salvar</button>
        </div>
        <div id="campoCancelar" class="hidden">
            <label>Digite o numero da OS/PV:</label>
            <input type="text" id="numeroCancelar" inputmode="numeric" pattern="[0-9]*" oninput="validarCancelar()">
            <button id="btnConfirmarCancelar" disabled onclick="cancelarPedido()">Remover</button>
        </div>
        <div id="campoImpressao" class="hidden">
            <label>Quem imprimiu:</label>
            <select id="inputImpressor" onchange="validarImpressao()"></select>
            <button id="btnImpressao" disabled onclick="confirmarImpressao()">Enviar para Em Separacao</button>
        </div>
        <div id="campoSeparador" class="hidden">
            <label>Quem separou:</label>
            <select id="inputSeparador" onchange="validarSeparador()"></select>
            <button id="btnSeparador" disabled onclick="confirmarSeparacao()">Enviar para Aguardando Retirada</button>
        </div>
        <div id="campoRetirada" class="hidden">
            <label>Tecnico/Responsavel:</label>
            <input type="text" id="inputTecnico" oninput="validarRetirada()">
            <label>Conferente:</label>
            <select id="inputConferente" onchange="validarRetirada()"></select>
            <button id="btnRetirada" disabled onclick="finalizar()">Finalizar</button>
        </div>
        <div id="campoEquipe" class="hidden">
            <h4>Cadastro da Equipe</h4>
            <label>Nome:</label>
            <input type="text" id="nomeEquipe" placeholder="Nome completo">
            <button onclick="adicionarPessoaEquipe()">Adicionar</button>
            <small style="display:block; color:#555; margin-top:6px;">Cadastro unico para Impressao, Separacao e Conferente. Edicao com senha.</small>
            <div id="listaEquipe" style="margin-top:12px; color:#000;"></div>
            <button onclick="fecharModal()" style="background:#ccc; margin-top:8px;">Fechar</button>
        </div>
        <div id="campoEditar" class="hidden">
            <label>Tipo:</label>
            <select id="editTipo">
                <option value="OS">OS</option>
                <option value="PV">PV</option>
            </select>
            <label>Numero:</label>
            <input type="text" id="editNumero" inputmode="numeric" pattern="[0-9]*">
            <label>Nome Tecnico / Cliente:</label>
            <input type="text" id="editNome">
            <label>Vendedor:</label>
            <input type="text" id="editVendedor">
            <label>Data de Instalacao:</label>
            <input type="date" id="editDataInstalacao">
            <select id="editPeriodoInstalacao">
                <option value="">Selecione o periodo</option>
                <option value="Manha">Manha</option>
                <option value="Tarde">Tarde</option>
            </select>
            <label>Observacao:</label>
            <textarea id="editObservacao" rows="3" placeholder="Detalhes importantes, problemas informados, etc..."></textarea>

            <div id="reentradaMotivoContainer" style="display:none; margin-top:16px; padding-top:16px; border-top:2px solid #ffc107;">
                <label>Motivo da Reentrada (obrigatorio):</label>
                <textarea id="motivoReentrada" rows="3" placeholder="Ex: Cliente pediu alteracao / Erro na separacao / ..." required></textarea>
                <div id="avisoMotivoReentrada">ATENCAO: O motivo da reentrada e obrigatorio!</div>
            </div>

            <button onclick="salvarEdicao()">Salvar Alteracoes</button>
            <button onclick="fecharModal()" style="background:#ccc; margin-top:5px;">Cancelar</button>
        </div>
        <div id="campoHistorico" class="hidden">
            <h4>Historico de Finalizados</h4>
            <button id="btnExportarHistorico" onclick="exportarHistoricoCSV()" style="background:#006400; color:#fff; margin:10px 0;">Exportar Historico para Excel (CSV)</button>
            <button id="btnDadosProducao" onclick="alternarGraficoProducao()" style="background:#353d61; color:#fff; margin:10px 0;">Dados de Producao</button>
            <input type="text" id="buscaHistorico" placeholder="Pesquisar por numero, nome, tipo ou vendedor..." style="width:100%; padding:12px; margin:10px 0; border-radius:8px; border:1px solid #ccc; font-size:16px;">
            <div id="graficoProducaoContainer" style="display:none; margin:10px 0; padding:10px; border:2px solid #353d61; border-radius:10px; background:#f7f7f7; color:#000;"></div>
            <div id="listaHistorico"></div>
            <button onclick="fecharModal()">Fechar</button>
        </div>
    </div>
</div>
<!-- IMPORTANTÍSSIMO: socket.io ANTES do script inline, para não quebrar socket.emit -->
<script src="/socket.io/socket.io.js"></script>
<script src="client.js"></script>

<script>
/* ------------------------- Variável global para filtro persistente ------------------------- */
let termoBuscaAtivo = "";

/* Variáveis para controle de reentrada */
let isReentradaMode = false;
let pedidoReentradaAtual = null;

/* NOVO: guarda de onde veio o pedido reentrado (pedidos/historico) */
let reentradaOrigem = null;

/* NOVO: emissor seguro (não quebra se socket não existir) */
function emitSocket(evento, payload) {
    try {
        if (window.socket && typeof window.socket.emit === "function") {
            window.socket.emit(evento, payload);
        }
    } catch (e) {
        // Silencia para não quebrar o fluxo local
        console.warn("Falha ao emitir socket:", evento, e);
    }
}

/* ------------------------- Relógio ------------------------- */
function atualizarRelogio() {
    const agora = new Date();
    const h = agora.toLocaleTimeString("pt-BR");
    const d = agora.toLocaleDateString("pt-BR");
    document.getElementById("relogio").innerHTML = `${d} — ${h}`;
}
setInterval(atualizarRelogio,1000);
atualizarRelogio();
/* ------------------------- Banco local ------------------------- */
let pedidos = JSON.parse(localStorage.getItem("pedidos")) || [];
let historicoFinalizados = JSON.parse(localStorage.getItem("historicoFinalizados")) || [];
const NOMES_EQUIPE_PADRAO = [
    "BRUNO",
    "JOAO",
    "JUNIOR",
    "PAULO",
    "FABIANO",
    "LEONARDO ASSUNÇÃO",
    "FIGUEIREDO",
    "ADRIANO",
    "JOSE",
    "S/DADOS"
];

let equipeCadastro = JSON.parse(localStorage.getItem("equipeCadastro"));
if (!equipeCadastro || typeof equipeCadastro !== "object") {
    equipeCadastro = { impressao: [], separacao: [], conferente: [] };
}

if (!localStorage.getItem("equipeCadastro")) {
    equipeCadastro = {
        impressao: [...NOMES_EQUIPE_PADRAO],
        separacao: [...NOMES_EQUIPE_PADRAO],
        conferente: [...NOMES_EQUIPE_PADRAO]
    };
}

const SENHA_INICIAL_EQUIPE = "1234";
let credenciaisEquipe = JSON.parse(localStorage.getItem("credenciaisEquipe"));
if (!credenciaisEquipe || typeof credenciaisEquipe !== "object") {
    credenciaisEquipe = {};
}

function chaveFuncionario(nome) {
    return String(nome || "").trim().toUpperCase();
}

function normalizarEquipeCadastro() {
    const unificados = [];
    ["impressao", "separacao", "conferente"].forEach(funcao => {
        const lista = Array.isArray(equipeCadastro[funcao]) ? equipeCadastro[funcao] : [];
        lista.forEach(nome => {
            const limpo = String(nome || "").trim();
            if (limpo && !unificados.some(x => x.toLowerCase() === limpo.toLowerCase())) {
                unificados.push(limpo);
            }
        });
    });
    unificados.sort((a, b) => a.localeCompare(b, "pt-BR"));
    equipeCadastro = {
        impressao: [...unificados],
        separacao: [...unificados],
        conferente: [...unificados]
    };
}

function normalizarCredenciaisEquipe() {
    const nomes = new Map();
    ["impressao", "separacao", "conferente"].forEach(funcao => {
        (equipeCadastro[funcao] || []).forEach(nome => {
            const limpo = String(nome || "").trim();
            if (!limpo) return;
            const key = chaveFuncionario(limpo);
            if (!nomes.has(key)) nomes.set(key, limpo);
        });
    });

    const base = {};
    nomes.forEach((nomeOriginal, key) => {
        const atual = credenciaisEquipe[key] || {};
        const senhaValida = (typeof atual.senha === "string" && /^\d{4}$/.test(atual.senha)) ? atual.senha : SENHA_INICIAL_EQUIPE;
        let precisaTrocar = (typeof atual.precisaTrocar === "boolean") ? atual.precisaTrocar : (senhaValida === SENHA_INICIAL_EQUIPE);
        if (senhaValida === SENHA_INICIAL_EQUIPE) precisaTrocar = true;

        base[key] = {
            nome: nomeOriginal,
            senha: senhaValida,
            precisaTrocar
        };
    });

    credenciaisEquipe = base;
}


function resetarTodasSenhasEquipePara1234() {
    Object.keys(credenciaisEquipe).forEach(key => {
        credenciaisEquipe[key].senha = SENHA_INICIAL_EQUIPE;
        credenciaisEquipe[key].precisaTrocar = true;
    });
    salvarBanco();
    sincronizarEquipeServidor();
}

function definirSenhaFuncionario(nome, senha4, precisaTrocar = false) {
    const key = chaveFuncionario(nome);
    if (!credenciaisEquipe[key]) return;
    if (!/^\d{4}$/.test(String(senha4 || ""))) return;
    credenciaisEquipe[key].senha = String(senha4);
    credenciaisEquipe[key].precisaTrocar = !!precisaTrocar;
}

function solicitarCadastroNovaSenha(nome, onConcluido) {
    const key = chaveFuncionario(nome);
    if (!credenciaisEquipe[key]) return;

    abrirSenhaModal(`Nova senha - ${nome}`, (novaSenha) => {
        const nova = String(novaSenha || "").trim();
        if (!/^\d{4}$/.test(nova)) {
            alert("A senha deve ter exatamente 4 digitos.");
            return false;
        }
        if (nova === SENHA_INICIAL_EQUIPE) {
            alert("Use uma senha diferente de 1234.");
            return false;
        }

        abrirSenhaModal(`Confirmar nova senha - ${nome}`, (confirmacao) => {
            const conf = String(confirmacao || "").trim();
            if (conf !== nova) {
                alert("As senhas nao conferem.");
                return false;
            }

            credenciaisEquipe[key].senha = nova;
            credenciaisEquipe[key].precisaTrocar = false;
            salvarBanco();
            sincronizarEquipeServidor();
            onConcluido();
            return true;
        }, {
            somente4Digitos: true,
            label: "Confirme sua nova senha:",
            hint: "Repita os mesmos 4 digitos.",
            placeholder: ""
        });

        return false;
    }, {
        somente4Digitos: true,
        label: "Cadastre sua senha pessoal:",
        hint: "Primeiro acesso detectado. Crie uma senha de 4 digitos.",
        placeholder: "1234"
    });
}

function autenticarFuncionario(nome, onSucesso) {
    const key = chaveFuncionario(nome);
    const cred = credenciaisEquipe[key];
    if (!cred) {
        alert("Funcionario sem cadastro de senha.");
        return;
    }
    const primeiroLogin = (cred.precisaTrocar || cred.senha === SENHA_INICIAL_EQUIPE);
    const hintLogin = primeiroLogin
        ? "PARA LOGAR DIGITE 1234, APOS CADASTRE SUA SENHA DE 4 DIGITOS"
        : "Use os 4 digitos cadastrados para liberar esta etapa.";

    abrirSenhaModal(`Acesso - ${nome}`, (senhaDigitada) => {
        const senha = String(senhaDigitada || "").replace(/\D/g, "").trim();
        const credAtual = credenciaisEquipe[key];
        if (!credAtual) {
            alert("Funcionario sem cadastro de senha.");
            emitSocket("solicitarEstado");
            return false;
        }

        if (!/^\d{4}$/.test(senha)) {
            alert("Informe uma senha de 4 digitos.");
            return false;
        }
        if (senha !== credAtual.senha) {
            emitSocket("solicitarEstado");
            alert("Senha incorreta.");
            return false;
        }

        if (credAtual.precisaTrocar || credAtual.senha === SENHA_INICIAL_EQUIPE) {
            solicitarCadastroNovaSenha(nome, onSucesso);
            return false;
        }

        onSucesso();
        return true;
    }, {
        somente4Digitos: true,
        label: "Digite sua senha:",
        hint: hintLogin,
        placeholder: ""
    });
}

function salvarBanco() {
    localStorage.setItem("pedidos", JSON.stringify(pedidos));
    localStorage.setItem("historicoFinalizados", JSON.stringify(historicoFinalizados));
    localStorage.setItem("equipeCadastro", JSON.stringify(equipeCadastro));
    localStorage.setItem("credenciaisEquipe", JSON.stringify(credenciaisEquipe));
}

function sincronizarEquipeServidor() {
    emitSocket("atualizarEquipeDados", {
        equipeCadastro,
        credenciaisEquipe
    });
}

function preencherSelectEquipe(selectId, funcao, placeholder) {
    const select = document.getElementById(selectId);
    if (!select) return;

    const lista = equipeCadastro[funcao] || [];
    select.innerHTML = "";

    const opcaoPadrao = document.createElement("option");
    opcaoPadrao.value = "";
    opcaoPadrao.textContent = placeholder;
    select.appendChild(opcaoPadrao);

    lista.forEach(nome => {
        const option = document.createElement("option");
        option.value = nome;
        option.textContent = nome;
        select.appendChild(option);
    });

    select.value = "";
}

function popularSelectOperadores() {
    preencherSelectEquipe("inputImpressor", "impressao", "Selecione quem imprimiu");
    preencherSelectEquipe("inputSeparador", "separacao", "Selecione quem separou");
    preencherSelectEquipe("inputConferente", "conferente", "Selecione o conferente");
}

function renderizarListaEquipe() {
    const el = document.getElementById("listaEquipe");
    if (!el) return;

    const lista = equipeCadastro.impressao || [];
    if (!lista.length) {
        el.innerHTML = "<small>Nenhum cadastrado.</small>";
        return;
    }

    const escapar = (nome) => String(nome).replace(/\\/g, "\\\\").replace(/'/g, "\\'");
    el.innerHTML = lista.map(nome =>
        `<div style="margin-bottom:8px;">
            <strong>${nome}</strong>
            <button type="button" onclick="editarPessoaEquipe('${escapar(nome)}')" style="width:auto; padding:4px 8px; margin:0 0 0 8px; background:#ff8c00; color:#000;">Editar</button>
            <button type="button" onclick="removerPessoaEquipe('${escapar(nome)}')" style="width:auto; padding:4px 8px; margin:0 0 0 6px; background:#b00020;">Remover</button>
        </div>`
    ).join("");
}

function abrirCadastroEquipe() {
    abrirModal();
    document.getElementById("modalTitulo").innerText = "Cadastro de Equipe";
    document.getElementById("campoEquipe").classList.remove("hidden");
    document.getElementById("modalInfo").textContent = "";
    document.getElementById("modalInfo").style.display = "none";
    document.getElementById("nomeEquipe").focus();
    renderizarListaEquipe();
}

function adicionarPessoaEquipe() {
    const nomeInput = document.getElementById("nomeEquipe");
    const nome = nomeInput.value.trim();

    if (!nome) {
        alert("Informe o nome para cadastrar.");
        nomeInput.focus();
        return;
    }

    const existe = (equipeCadastro.impressao || []).some(x => x.toLowerCase() === nome.toLowerCase());
    if (existe) {
        alert("Esse nome ja esta cadastrado.");
        return;
    }

    equipeCadastro.impressao.push(nome);
    normalizarEquipeCadastro();
    normalizarCredenciaisEquipe();
    salvarBanco();
    sincronizarEquipeServidor();
    popularSelectOperadores();
    renderizarListaEquipe();
    nomeInput.value = "";
    nomeInput.focus();
}

function removerPessoaEquipe(nome) {
    const SENHA_EDICAO_EQUIPE = "3105";
    abrirSenhaModal(`Remover cadastro - ${nome}`, (senha) => {
        if (String(senha || "").trim() !== SENHA_EDICAO_EQUIPE) {
            alert("Senha incorreta.");
            return false;
        }

        ["impressao", "separacao", "conferente"].forEach(funcao => {
            equipeCadastro[funcao] = (equipeCadastro[funcao] || []).filter(x => x !== nome);
        });
        delete credenciaisEquipe[chaveFuncionario(nome)];
        normalizarEquipeCadastro();
        normalizarCredenciaisEquipe();
        salvarBanco();
        sincronizarEquipeServidor();
        popularSelectOperadores();
        renderizarListaEquipe();
        return true;
    }, {
        somente4Digitos: true,
        label: "Digite sua senha:",
        hint: "Autenticacao necessaria para remover cadastro.",
        placeholder: "0000"
    });
}

function editarPessoaEquipe(nomeAtual) {
    const SENHA_EDICAO_EQUIPE = "3105";
    abrirSenhaModal(`Editar cadastro - ${nomeAtual}`, (senha) => {
        if (String(senha || "").trim() !== SENHA_EDICAO_EQUIPE) {
            alert("Senha incorreta.");
            return false;
        }

        const novoNome = (prompt(`Novo nome para ${nomeAtual}:`) || "").trim();
        if (!novoNome) return false;

        const existe = (equipeCadastro.impressao || []).some(x => x.toLowerCase() === novoNome.toLowerCase() && x.toLowerCase() !== nomeAtual.toLowerCase());
        if (existe) {
            alert("Ja existe cadastro com esse nome.");
            return false;
        }

        ["impressao", "separacao", "conferente"].forEach(funcao => {
            equipeCadastro[funcao] = (equipeCadastro[funcao] || []).map(x => x === nomeAtual ? novoNome : x);
        });

        const keyAntiga = chaveFuncionario(nomeAtual);
        const keyNova = chaveFuncionario(novoNome);
        if (credenciaisEquipe[keyAntiga]) {
            credenciaisEquipe[keyNova] = { ...credenciaisEquipe[keyAntiga], nome: novoNome };
            if (keyNova !== keyAntiga) delete credenciaisEquipe[keyAntiga];
        }

        normalizarEquipeCadastro();
        normalizarCredenciaisEquipe();
        salvarBanco();
        sincronizarEquipeServidor();
        popularSelectOperadores();
        abrirCadastroEquipe();
        return true;
    }, {
        somente4Digitos: true,
        label: "Digite sua senha:",
        hint: "Autenticacao necessaria para editar cadastro.",
        placeholder: "0000"
    });
}
/* ------------------------- Contadores ------------------------- */
function atualizarContadores() {
    const contagem = {
        impressao: 0,
        em_separacao: 0,
        aguardando_retirada: 0,
        finalizados: 0
    };

    pedidos.forEach(p => {
        if (contagem[p.status] !== undefined) {
            contagem[p.status]++;
        }
    });

    document.querySelectorAll('.contador').forEach(el => {
        const status = el.dataset.status;
        if (status && contagem[status] !== undefined) {
            el.textContent = `(${contagem[status]})`;
        }
    });

    // Total no cabeçalho
    document.getElementById("totalCards").textContent = pedidos.length;
}

/* ------------------------- PESQUISA DE OS/PV - FILTRO PERSISTENTE ------------------------- */
function pesquisarPedido() {
    const input = document.getElementById("pesquisaOSPV");
    termoBuscaAtivo = input.value.trim().toLowerCase();
    if (!termoBuscaAtivo) termoBuscaAtivo = "";
    renderizar();
}

function alternarMenuAcoes() {
    const menu = document.getElementById("submenuAcoes");
    if (menu) menu.classList.toggle("hidden");
}

function fecharMenuAcoes() {
    const menu = document.getElementById("submenuAcoes");
    if (menu) menu.classList.add("hidden");
}

function executarAcaoMenu(acao) {
    fecharMenuAcoes();
    if (typeof acao === "function") acao();
}

function abrirDadosProducaoMenu() {
    abrirHistorico();
    const grafico = document.getElementById("graficoProducaoContainer");
    if (!grafico) return;
    grafico.style.display = "block";
    renderizarGraficoProducao();
    document.getElementById("modalTitulo").innerText = "Dados de Producao";
    const busca = document.getElementById("buscaHistorico");
    const lista = document.getElementById("listaHistorico");
    const btnExportar = document.getElementById("btnExportarHistorico");
    const btnDados = document.getElementById("btnDadosProducao");
    if (busca) busca.style.display = "none";
    if (lista) lista.style.display = "none";
    if (btnExportar) btnExportar.style.display = "none";
    if (btnDados) btnDados.style.display = "none";
}

/* ------------------------- Apenas nÃºmeros ------------------------- */
function apenasNumeros(e) {
    const permitidas = ['0','1','2','3','4','5','6','7','8','9','Backspace','Delete','Tab','ArrowLeft','ArrowRight'];
    if (permitidas.includes(e.key) || (e.ctrlKey && ['v','c','a'].includes(e.key.toLowerCase()))) {
        return;
    }
    e.preventDefault();
}

function limparNaoNumeros(el) {
    el.value = el.value.replace(/\D/g, '');
}

/* ------------------------- Regras de alerta de prazo ------------------------- */
const MS_DIA = 24 * 60 * 60 * 1000;

function normalizarDataInstalacao(dataInstalacao) {
    if (!dataInstalacao) return null;
    const partes = dataInstalacao.split(" - ");
    const dataParte = partes[0] || "";
    const [dia, mes, ano] = dataParte.split("/");
    if (!dia || !mes || !ano) return null;
    const d = new Date(parseInt(ano, 10), parseInt(mes, 10) - 1, parseInt(dia, 10));
    return isNaN(d.getTime()) ? null : d;
}

function obterDataCriacao(pedido) {
    const historico = pedido.historico || [];
    const criado = historico.find(h => (h.acao || "").startsWith("Criado"));
    if (criado && criado.hora) return new Date(criado.hora);
    const primeira = historico[0];
    return primeira && primeira.hora ? new Date(primeira.hora) : null;
}

function isInstalacaoProxima(pedido, diasLimite = 1) {
    const dataInst = normalizarDataInstalacao(pedido.dataInstalacao);
    if (!dataInst) return false;
    const hoje = new Date();
    const hojeZerado = new Date(hoje.getFullYear(), hoje.getMonth(), hoje.getDate());
    const diffDias = Math.floor((dataInst - hojeZerado) / MS_DIA);
    return diffDias >= 0 && diffDias <= diasLimite;
}

function isMaisDe7Dias(pedido) {
    const dataCriacao = obterDataCriacao(pedido);
    if (!dataCriacao) return false;
    const diffDias = Math.floor((Date.now() - dataCriacao.getTime()) / MS_DIA);
    return diffDias > 7;
}
/* ------------------------- Renderizar - RESPEITA FILTRO DE BUSCA ------------------------- */
function renderizar() {
    const colunas = {
        impressao: document.getElementById("impressao"),
        em_separacao: document.getElementById("em_separacao"),
        aguardando_retirada: document.getElementById("aguardando_retirada"),
        finalizados: document.getElementById("finalizados")
    };

    for (const c in colunas) colunas[c].innerHTML = "";

    pedidos.forEach(p => {
        // Só cria o card se passar no filtro de busca (ou se não houver busca ativa)
        const numeroSafe = (p.numero || "").toString().toLowerCase();
        const nomeSafe = (p.nome || "").toString().toLowerCase();
        const vendedorSafe = (p.vendedor || "").toString().toLowerCase();
        const observacaoSafe = (p.observacao || "").toString().toLowerCase();

        if (termoBuscaAtivo &&
            !numeroSafe.includes(termoBuscaAtivo) &&
            !nomeSafe.includes(termoBuscaAtivo) &&
            !vendedorSafe.includes(termoBuscaAtivo) &&
            !observacaoSafe.includes(termoBuscaAtivo)) {
            return; // pula este pedido
        }

        let div = document.createElement("div");
        let classeCor = "";
        if (p.status === "impressao") {
            classeCor = "impressao-card";
        } else if (p.status === "em_separacao") {
            classeCor = "separacao-card";
        } else if (p.status === "aguardando_retirada") {
            classeCor = p.tipo === "PV" ? "aguardando-pv" : "aguardando-os";
        } else if (p.status === "finalizados") {
            classeCor = "finalizado-card";
        }
        div.className = `card ${classeCor} ${p.reentrado ? 'reentrado' : ''}`;

        const instalacaoProxima = isInstalacaoProxima(p);
        const maisDe7Dias = isMaisDe7Dias(p);
        const precisaAlerta = instalacaoProxima || maisDe7Dias;
        if (precisaAlerta) {
            div.classList.add("prazo-alerta");
        }

        // Adiciona classe de piscar se tiver observação
        if (p.observacao && p.observacao.trim() !== "") {
            div.classList.add("tem-observacao");
        }

        let dataHora = new Date(p.historico[p.historico.length-1]?.hora || Date.now()).toLocaleString("pt-BR");

        let etiquetaAlerta = "";
        if (precisaAlerta) {
            let textoAlerta = instalacaoProxima && maisDe7Dias
                ? "ATENCAO"
                : (instalacaoProxima ? "INSTALACAO PROXIMA" : "MAIS DE 7 DIAS");
            let tituloAlerta = [];
            if (instalacaoProxima) tituloAlerta.push("Instalacao proxima");
            if (maisDe7Dias) tituloAlerta.push("Mais de 7 dias desde o cadastro");
            const classeEtiqueta = (instalacaoProxima && !maisDe7Dias) ? "etiqueta-alerta roxa" : "etiqueta-alerta";
            etiquetaAlerta = `<div class="${classeEtiqueta}" title="${tituloAlerta.join(' / ')}">${textoAlerta}</div>`;
        }

        let linhaInstalacao = "";
        if (p.dataInstalacao) {
            linhaInstalacao = `<div style="font-size:13px; color:#000; margin:4px 0; line-height:1.2;">
                <strong>Instalação:</strong><br>${p.dataInstalacao}
            </div>`;
        }

        // Mostra observação resumida no card
        let observacaoResumida = "";
        if (p.observacao && p.observacao.trim() !== "") {
            let textoCurto = p.observacao.length > 60 
                ? p.observacao.substring(0, 57) + "..." 
                : p.observacao;
            observacaoResumida = `
                <div style="font-size:12px; margin:6px 0; padding:4px; background:rgba(0,0,0,0.15); border-radius:6px; color:#fff; line-height:1.3;">
                    <strong>Obs:</strong> ${textoCurto}
                </div>`;
        }

        div.innerHTML = `
            <div style="font-size:18px; margin-bottom:6px;">
                ${emojiStatus(p.status)} ${p.tipo} ${p.numero}
            </div>
            <div style="font-size:22px; margin:10px 0;">
                ${p.nome}
            </div>
            ${etiquetaAlerta}
            ${linhaInstalacao}
            ${observacaoResumida}
            <div style="font-size:14px; opacity:0.9;">
                ${dataHora}
            </div>
        `;

        if(p.status === "finalizados") div.onclick = () => abrirPedidoFinalizado(p.numero);
        else div.onclick = () => abrirPedido(p.numero);
        colunas[p.status].appendChild(div);
    });

    atualizarContadores();
}
function emojiStatus(status) {
    return {
        impressao: "🖨️",
        em_separacao: "📦",
        aguardando_retirada: "📫",
        finalizados: "✅"
    }[status];
}

/* ------------------------- REENTRADA COM SENHA ------------------------- */
function abrirReentradaComSenha() {
    const senhaCorreta = "2025";

    abrirSenhaModal("Reentrar OS/PV", (senhaDigitada) => {
        if (senhaDigitada !== senhaCorreta) {
            if (senhaDigitada) alert("Senha incorreta!");
            return false;
        }

        document.getElementById("campoSenha").classList.add("hidden");

        const numero = (prompt("Digite o numero da OS ou PV que deseja reentrar:") || "").trim();

        if (!numero) {
            alert("Numero invalido.");
            fecharModal();
            return true;
        }

        // Primeiro procura nos pedidos ativos
        let pedido = pedidos.find(p => p.numero === numero);

        // Se nao achar, procura no historico
        if (!pedido) {
            pedido = historicoFinalizados.find(p => p.numero === numero);
            if (pedido) {
                reentradaOrigem = "historico";
                // clona para nao mexer direto no historico antes de salvar
                pedido = JSON.parse(JSON.stringify(pedido));
            }
        } else {
            reentradaOrigem = "pedidos";
        }

        if (!pedido) {
            alert("Pedido nao encontrado em nenhum status (nem nos finalizados).");
            fecharModal();
            return true;
        }

        pedidoReentradaAtual = pedido;
        isReentradaMode = true;

        abrirModal();
        document.getElementById("modalTitulo").innerText = "Reentrar Pedido";
        document.getElementById("modalInfo").style.display = "none";
        document.getElementById("campoEditar").classList.remove("hidden");
        document.getElementById("reentradaMotivoContainer").style.display = "block";

        // Preenche campos com dados do pedido
        document.getElementById("editTipo").value = pedido.tipo;
        document.getElementById("editNumero").value = pedido.numero;
        document.getElementById("editNome").value = pedido.nome;
        document.getElementById("editVendedor").value = pedido.vendedor || "";
        document.getElementById("editObservacao").value = pedido.observacao || "";

        if (pedido.dataInstalacao) {
            const partes = pedido.dataInstalacao.split(" - ");
            if (partes.length === 2) {
                const [dia, mes, ano] = partes[0].split("/");
                document.getElementById("editDataInstalacao").value = `${ano}-${mes.padStart(2, '0')}-${dia.padStart(2, '0')}`;
                document.getElementById("editPeriodoInstalacao").value = partes[1];
            }
        } else {
            document.getElementById("editDataInstalacao").value = "";
            document.getElementById("editPeriodoInstalacao").value = "";
        }

        document.getElementById("motivoReentrada").value = "";
        document.getElementById("avisoMotivoReentrada").style.display = "none";
        return true;
    });
}

/* ------------------------- EXPORTAR PEDIDOS ATUAIS (COM QUEM FEZ CADA ETAPA) ------------------------- */
function exportarPedidosAtuaisCSV() {
    if (pedidos.length === 0) {
        alert("Não há pedidos para exportar.");
        return;
    }

    let csv = "Status;Tipo;Número;Cliente;Vendedor;Data Instalação;Observação;";
    csv += "Quem Imprimiu;Hora Impressão;";
    csv += "Quem Separou;Hora Separação;";
    csv += "Quem Retirou;Quem Conferiu;Hora Retirada;Última Ação;Data/Hora Última Ação\n";

    pedidos.forEach(p => {
        let quemImprimiu = "", horaImpressao = "";
        let quemSeparou = "", horaSeparacao = "";
        let quemRetirou = "", quemConferiu = "", horaRetirada = "";

        p.historico.forEach(h => {
            const dt = new Date(h.hora).toLocaleString("pt-BR");
            if (h.acao.includes("Impresso por")) {
                quemImprimiu = h.acao.replace("Impresso por ", "");
                horaImpressao = dt;
            } else if (h.acao.includes("Separado por")) {
                quemSeparou = h.acao.replace("Separado por ", "");
                horaSeparacao = dt;
            } else if (h.acao.includes("Retirado por")) {
                const partes = h.acao.split(", conferido por ");
                quemRetirou = partes[0].replace("Retirado por ", "");
                quemConferiu = partes[1] || "";
                horaRetirada = dt;
            }
        });

        const ultimaAcao = p.historico?.[p.historico.length - 1] || { acao: "Sem histórico", hora: 0 };
        const dataUltima = new Date(ultimaAcao.hora).toLocaleString("pt-BR");

        let statusFormatado = p.status === "impressao" ? "Impressão" :
                              p.status === "em_separacao" ? "Em Separação" :
                              p.status === "aguardando_retirada" ? "Aguardando Retirada" :
                              p.status === "finalizados" ? "Finalizados" : p.status;

        csv += `"${statusFormatado}";"${p.tipo}";"${p.numero}";"${(p.nome || "").replace(/"/g,'""')}";"${(p.vendedor || "").replace(/"/g,'""')}";"${(p.dataInstalacao || "")}";"${(p.observacao || "").replace(/"/g,'""').replace(/\n/g, ' | ')}";`;
        csv += `"${quemImprimiu}";"${horaImpressao}";"${quemSeparou}";"${horaSeparacao}";"${quemRetirou}";"${quemConferiu}";"${horaRetirada}";"${ultimaAcao.acao.replace(/"/g,'""')}";"${dataUltima}"\n`;
    });

    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement("a");
    link.href = url;
    link.download = `pedidos_saba_atual_${new Date().toISOString().slice(0,10)}.csv`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

/* ------------------------- Modal ------------------------- */
function abrirModal() { document.getElementById("modal").style.visibility = "visible"; }
function fecharModal() {
    document.getElementById("modal").style.visibility = "hidden";
    document.querySelectorAll(".modal-content > div").forEach(d => d.classList.add("hidden"));
    document.querySelectorAll(".modal-content input, .modal-content textarea, .modal-content select").forEach(el => el.value = "");
    senhaPendenteCallback = null;
    isReentradaMode = false;
    pedidoReentradaAtual = null;
    reentradaOrigem = null;
    document.getElementById("reentradaMotivoContainer").style.display = "none";
    document.getElementById("avisoMotivoReentrada").style.display = "none";
    document.getElementById("modalInfo").style.display = "block";
}
/* ------------------------- Senha (modal bonito) ------------------------- */
let senhaPendenteCallback = null;
let senhaModalConfig = {
    somente4Digitos: false,
    hint: "Informe sua senha para continuar.",
    label: "Digite a senha:",
    placeholder: ""
};

function abrirSenhaModal(titulo, onOk, opcoes = {}) {
    abrirModal();
    document.getElementById("modalTitulo").innerText = titulo;
    document.getElementById("modalInfo").textContent = "";
    document.getElementById("modalInfo").style.display = "none";
    document.querySelectorAll(".modal-content > div").forEach(d => d.classList.add("hidden"));
    document.getElementById("campoSenha").classList.remove("hidden");

    senhaModalConfig = {
        somente4Digitos: !!opcoes.somente4Digitos,
        hint: opcoes.hint || "Informe sua senha para continuar.",
        label: opcoes.label || "Digite a senha:",
        placeholder: opcoes.placeholder || ""
    };

    document.getElementById("senhaLabel").textContent = senhaModalConfig.label;
    document.getElementById("senhaHint").textContent = senhaModalConfig.hint;

    senhaPendenteCallback = onOk;
    document.getElementById("btnConfirmarSenha").disabled = true;

    const input = document.getElementById("inputSenha");
    input.value = "";
    input.placeholder = senhaModalConfig.placeholder;
    input.maxLength = senhaModalConfig.somente4Digitos ? 4 : 32;
    input.inputMode = senhaModalConfig.somente4Digitos ? "numeric" : "text";
    input.focus();
}

function validarSenha() {
    const input = document.getElementById("inputSenha");
    if (senhaModalConfig.somente4Digitos) {
        input.value = input.value.replace(/\D/g, "").slice(0, 4);
    }
    const valor = input.value.trim();
    document.getElementById("btnConfirmarSenha").disabled = senhaModalConfig.somente4Digitos ? valor.length !== 4 : valor === "";
}

function confirmarSenha() {
    const senha = document.getElementById("inputSenha").value.trim();
    const cb = senhaPendenteCallback;
    if (!cb) return;
    const ok = cb(senha) === true;
    if (ok) {
        senhaPendenteCallback = null;
        document.getElementById("campoSenha").classList.add("hidden");
    } else {
        const input = document.getElementById("inputSenha");
        if (input) input.focus();
    }
}

/* ------------------------- Cadastro ------------------------- */
function abrirCadastro() {
    abrirModal();
    document.getElementById("modalTitulo").innerText = "Novo Cadastro";
    document.getElementById("campoCadastro").classList.remove("hidden");

    document.getElementById("modalInfo").textContent = "";
    document.getElementById("modalInfo").style.display = "block";
}
function cadastrar() {
    let tipo = document.getElementById("tipo").value;
    let numero = document.getElementById("numero").value.trim();
    let nome = document.getElementById("nome").value.trim();
    let vendedor = document.getElementById("vendedor").value.trim();
    let dataInstalacaoInput = document.getElementById("dataInstalacao").value;
    let periodoInstalacao = document.getElementById("periodoInstalacao").value;
    let observacao = document.getElementById("observacao").value.trim();

    if(!numero||!nome) return alert("Preencha todos os campos!");

    let dataInstalacao = "";
    if (dataInstalacaoInput && periodoInstalacao) {
        const [ano, mes, dia] = dataInstalacaoInput.split("-");
        dataInstalacao = `${dia}/${mes}/${ano} - ${periodoInstalacao}`;
    }

    pedidos.push({tipo,numero,nome,vendedor,dataInstalacao,observacao,status:"impressao",historico:[{acao:"Criado",hora:new Date().getTime()}]});
    salvarBanco(); 
    termoBuscaAtivo = ""; // limpa busca após cadastro
    document.getElementById("pesquisaOSPV").value = "";
    renderizar(); fecharModal();
    atualizarContadores();

    emitSocket("adicionarPedido", { tipo, numero, nome, vendedor, dataInstalacao, observacao });
}
/* ------------------------- Cancelamento ------------------------- */
function senhaCancelar() {
    const senhaCorreta = "2025";

    abrirSenhaModal("Cancelar Pedido", (senhaDigitada) => {
        if (senhaDigitada === senhaCorreta) {
            document.getElementById("campoSenha").classList.add("hidden");
            abrirModal();
            document.getElementById("modalTitulo").innerText = "Cancelar Pedido";
            document.getElementById("campoCancelar").classList.remove("hidden");
            document.getElementById("numeroCancelar").focus();
            return true;
        } else if (senhaDigitada) {
            alert("Senha incorreta! Acesso negado.");
        }
        return false;
    });
}
function validarCancelar(){ document.getElementById("btnConfirmarCancelar").disabled = document.getElementById("numeroCancelar").value.trim()===""; }
function cancelarPedido() {
    let n = document.getElementById("numeroCancelar").value.trim();
    pedidos = pedidos.filter(p => p.numero !== n);
    salvarBanco(); 
    termoBuscaAtivo = ""; // limpa busca após cancelar
    document.getElementById("pesquisaOSPV").value = "";
    renderizar(); fecharModal();
    atualizarContadores();

    emitSocket("cancelarPedido", n);
}
/* ------------------------- Workflow ------------------------- */
let pedidoAtual = null;
function abrirPedido(numero) {
    pedidoAtual = pedidos.find(p=>p.numero===numero);
    abrirModal();
    document.getElementById("modalTitulo").innerText=`${pedidoAtual.tipo} ${pedidoAtual.numero}`;
    const reentradaTag = pedidoAtual.reentrado
        ? '<div style="display:inline-block; margin:6px 0 10px; padding:4px 8px; background:#000; color:rgb(255, 136, 0); font-weight:bold; border-radius:4px; font-size:12px;">↪ REENTRADA</div><br>'
        : '';
    const instalacaoProxima = isInstalacaoProxima(pedidoAtual);
    const maisDe7Dias = isMaisDe7Dias(pedidoAtual);
    const precisaAlerta = instalacaoProxima || maisDe7Dias;
    let etiquetaAlerta = "";
    if (precisaAlerta) {
        let textoAlerta = instalacaoProxima && maisDe7Dias
            ? "ATENCAO"
            : (instalacaoProxima ? "INSTALACAO PROXIMA" : "MAIS DE 7 DIAS");
        let tituloAlerta = [];
        if (instalacaoProxima) tituloAlerta.push("Instalacao proxima");
        if (maisDe7Dias) tituloAlerta.push("Mais de 7 dias desde o cadastro");
        const classeEtiqueta = (instalacaoProxima && !maisDe7Dias) ? "etiqueta-alerta roxa" : "etiqueta-alerta";
        etiquetaAlerta = `<div class="${classeEtiqueta}" title="${tituloAlerta.join(' / ')}">${textoAlerta}</div>`;
    }
    document.getElementById("modalInfo").innerHTML = `
        ${reentradaTag}
        ${etiquetaAlerta}
        Cliente/Técnico: <strong>${pedidoAtual.nome}</strong><br>
        Vendedor: <strong>${pedidoAtual.vendedor || "Não informado"}</strong><br>
        ${pedidoAtual.dataInstalacao ? 'Instalação: <strong>' + pedidoAtual.dataInstalacao + '</strong><br>' : ''}
        ${pedidoAtual.observacao ? '<br><strong>Observação:</strong><br><div style="white-space: pre-wrap; background:#f8f8f8; padding:10px; border-radius:6px; margin-top:8px; color:#333;">' + pedidoAtual.observacao + '</div>' : ''}
        <br>
        <button onclick="mostrarEdicao()" style="background:#ff8c00; color:black; padding:10px; border:none; border-radius:6px; font-weight:bold;">✏️ Editar OS/PV</button>
    `;

    document.getElementById("campoImpressao").classList.add("hidden");
    document.getElementById("campoSeparador").classList.add("hidden");
    document.getElementById("campoRetirada").classList.add("hidden");
    document.getElementById("campoEditar").classList.add("hidden");

    if (pedidoAtual.status === "impressao") {
        document.getElementById("campoImpressao").classList.remove("hidden");
    } else if (pedidoAtual.status === "em_separacao") {
        document.getElementById("campoSeparador").classList.remove("hidden");
    } else if (pedidoAtual.status === "aguardando_retirada") {
        document.getElementById("campoRetirada").classList.remove("hidden");
    }

    popularSelectOperadores();
    validarImpressao();
    validarSeparador();
    validarRetirada();
}
/* Impressão */
function validarImpressao(){ document.getElementById("btnImpressao").disabled=document.getElementById("inputImpressor").value.trim()===""; }
function confirmarImpressao(){
    let nome=document.getElementById("inputImpressor").value.trim();
    autenticarFuncionario(nome, () => {
        pedidoAtual.status="em_separacao";
        pedidoAtual.historico.push({acao:`Impresso por ${nome}`,hora:new Date().getTime()});
        salvarBanco(); renderizar(); fecharModal();
        atualizarContadores();

        emitSocket("moverPedido", {
            numero: pedidoAtual.numero,
            novoStatus: "em_separacao",
            historicoAtualizado: pedidoAtual.historico
        });
    });
}
/* Separação */
function validarSeparador(){ document.getElementById("btnSeparador").disabled=document.getElementById("inputSeparador").value.trim()===""; }
function confirmarSeparacao(){
    let nome=document.getElementById("inputSeparador").value.trim();
    autenticarFuncionario(nome, () => {
        pedidoAtual.status="aguardando_retirada";
        pedidoAtual.historico.push({acao:`Separado por ${nome}`,hora:new Date().getTime()});
        salvarBanco(); renderizar(); fecharModal();
        atualizarContadores();

        emitSocket("moverPedido", {
            numero: pedidoAtual.numero,
            novoStatus: "aguardando_retirada",
            historicoAtualizado: pedidoAtual.historico
        });
    });
}
/* Retirada */
function validarRetirada(){
    let t=document.getElementById("inputTecnico").value.trim();
    let c=document.getElementById("inputConferente").value.trim();
    document.getElementById("btnRetirada").disabled=!(t&&c);
}
function finalizar(){
    let t = document.getElementById("inputTecnico").value.trim();
    let c = document.getElementById("inputConferente").value.trim();

    autenticarFuncionario(c, () => {
        pedidoAtual.status = "finalizados";
        pedidoAtual.finalizadoEm = Date.now(); 

        pedidoAtual.historico.push({
            acao: `Retirado por ${t}, conferido por ${c}`,
            hora: pedidoAtual.finalizadoEm
        });

        salvarBanco();
        renderizar();
        fecharModal();
        atualizarContadores();

        emitSocket("moverPedido", {
            numero: pedidoAtual.numero,
            novoStatus: "finalizados",
            historicoAtualizado: pedidoAtual.historico
        });
    });
}

/* ------------------------- Edicao / Reentrada ------------------------- */
function mostrarEdicao() {
    const senhaCorreta = "2025";

    // esconde os botoes de fluxo antes de pedir a senha
    document.getElementById("campoImpressao").classList.add("hidden");
    document.getElementById("campoSeparador").classList.add("hidden");
    document.getElementById("campoRetirada").classList.add("hidden");

    abrirSenhaModal("Editar OS/PV", (senha) => {
        if (senha === senhaCorreta) {
            document.getElementById("campoSenha").classList.add("hidden");
            document.getElementById("editTipo").value = pedidoAtual.tipo;
            document.getElementById("editNumero").value = pedidoAtual.numero;
            document.getElementById("editNome").value = pedidoAtual.nome;
            document.getElementById("editVendedor").value = pedidoAtual.vendedor || "";

            document.getElementById("editObservacao").value = pedidoAtual.observacao || "";

            if (pedidoAtual.dataInstalacao) {
                const partes = pedidoAtual.dataInstalacao.split(" - ");
                if (partes.length === 2) {
                    const [dia, mes, ano] = partes[0].split("/");
                    document.getElementById("editDataInstalacao").value = `${ano}-${mes.padStart(2, '0')}-${dia.padStart(2, '0')}`;
                    document.getElementById("editPeriodoInstalacao").value = partes[1];
                }
            } else {
                document.getElementById("editDataInstalacao").value = "";
                document.getElementById("editPeriodoInstalacao").value = "";
            }

            document.getElementById("reentradaMotivoContainer").style.display = "none";
            document.getElementById("avisoMotivoReentrada").style.display = "none";

            document.getElementById("modalInfo").style.display = "none";
            document.getElementById("campoEditar").classList.remove("hidden");
            return true;
        } else if (senha) {
            alert("Senha incorreta!");
        }
        return false;
    });
}

function salvarEdicao() {
    let pedido = isReentradaMode ? pedidoReentradaAtual : pedidoAtual;
    if (!pedido) return;

    // NOVO: pega o índice antes de alterar número (corrige bug de "editar tudo e não salvar")
    // - se estiver editando um pedido que está no array "pedidos", pega o índice pelo número atual
    // - se for reentrada do histórico, o índice aqui pode ser -1 (e a gente trata mais abaixo)
    const indiceAntes = pedidos.findIndex(p => p.numero === pedido.numero);

    let novoTipo = document.getElementById("editTipo").value;
    let novoNumero = document.getElementById("editNumero").value.trim();
    let novoNome = document.getElementById("editNome").value.trim();
    let novoVendedor = document.getElementById("editVendedor").value.trim();
    let novaObservacao = document.getElementById("editObservacao").value.trim();
    let dataInput = document.getElementById("editDataInstalacao").value;
    let periodo = document.getElementById("editPeriodoInstalacao").value;

    if (!novoNumero || !novoNome) {
        return alert("Número e Nome são obrigatórios!");
    }

    let motivoReentrada = "";
    if (isReentradaMode) {
        motivoReentrada = document.getElementById("motivoReentrada").value.trim();
        if (!motivoReentrada) {
            document.getElementById("avisoMotivoReentrada").style.display = "block";
            document.getElementById("motivoReentrada").focus();
            return;
        }
    }

    const numeroAntigo = pedido.numero;

    // Impede duplicidade de número (verifica no array pedidos)
    if (novoNumero !== numeroAntigo && pedidos.some(p => p.numero === novoNumero)) {
        return alert("Já existe um pedido com este número!");
    }

    let novaDataInstalacao = "";
    if (dataInput && periodo) {
        const [ano, mes, dia] = dataInput.split("-");
        if (ano && mes && dia && ano.length === 4) {
            novaDataInstalacao = `${dia.padStart(2,'0')}/${mes.padStart(2,'0')}/${ano} - ${periodo}`;
        } else {
            alert("Data de instalação inválida!");
            return;
        }
    }

    pedido.tipo = novoTipo;
    pedido.numero = novoNumero;
    pedido.nome = novoNome;
    pedido.vendedor = novoVendedor;
    pedido.observacao = novaObservacao;
    pedido.dataInstalacao = novaDataInstalacao;

    if (isReentradaMode) {
        const dataReentrada = new Date().toLocaleString("pt-BR");
        const obsAntiga = pedido.observacao || "";
        pedido.observacao = obsAntiga 
            ? `${obsAntiga}\n\n↺ Reentrado em ${dataReentrada}: ${motivoReentrada}`
            : `↺ Reentrado em ${dataReentrada}: ${motivoReentrada}`;

        // VOLTA PARA IMPRESSÃO
        pedido.status = "impressao";
        pedido.finalizadoEm = null;

        pedido.historico.push({
            acao: `Reentrado para IMPRESSAO - Motivo: ${motivoReentrada}`,
            hora: Date.now()
        });

        pedido.reentrado = true;

        // NOVO: se veio do histórico, remove do histórico e garante que entra em "pedidos"
        if (reentradaOrigem === "historico") {
            historicoFinalizados = historicoFinalizados.filter(p => p.numero !== numeroAntigo);
            pedidos.push(JSON.parse(JSON.stringify(pedido)));
        } else {
            // se veio dos pedidos, garante atualização no array certo
            if (indiceAntes !== -1) {
                pedidos[indiceAntes] = JSON.parse(JSON.stringify(pedido));
            }
        }

    } else {
        pedido.historico.push({acao:"Editado (dados alterados)",hora:new Date().getTime()});

        // NOVO: atualiza no array correto usando o índice ANTES da mudança
        if (indiceAntes !== -1) {
            pedidos[indiceAntes] = JSON.parse(JSON.stringify(pedido));
        } else {
            // fallback de segurança (caso extremo)
            const idx2 = pedidos.findIndex(p => p.numero === numeroAntigo);
            if (idx2 !== -1) pedidos[idx2] = JSON.parse(JSON.stringify(pedido));
        }
    }

    salvarBanco();

    // LIMPA FILTRO E RENDERIZA PARA GARANTIR QUE O CARD NÃO SUMA
    termoBuscaAtivo = "";
    document.getElementById("pesquisaOSPV").value = "";
    renderizar();
    fecharModal();
    atualizarContadores();
    pedido.updatedAt = Date.now();

    emitSocket("editarPedido", {
        antigoNumero: numeroAntigo,
        atualizado: pedido
    });

    isReentradaMode = false;
    pedidoReentradaAtual = null;
    reentradaOrigem = null;
}

/* ------------------------- Histórico de Finalizados ------------------------- */
/* ------------------------- Graficos de Producao ------------------------- */
let filtroProducaoAtual = {
    periodo: "mes",
    referencia: new Date().toISOString().slice(0, 10)
};

function toTimestampSeguro(valor) {
    if (typeof valor === "number") return valor;
    if (typeof valor === "string") {
        const t = new Date(valor).getTime();
        return Number.isNaN(t) ? 0 : t;
    }
    return 0;
}

function intervaloProducao(periodo, referenciaIso) {
    const ref = referenciaIso ? new Date(`${referenciaIso}T00:00:00`) : new Date();
    const base = new Date(ref.getTime());
    base.setHours(0, 0, 0, 0);

    if (periodo === "dia") {
        const inicio = base.getTime();
        const fim = inicio + (24 * 60 * 60 * 1000) - 1;
        return { inicio, fim };
    }

    if (periodo === "semana") {
        const diaSemana = base.getDay(); // 0 domingo ... 6 sabado
        const offsetSegunda = diaSemana === 0 ? -6 : (1 - diaSemana);
        const inicioData = new Date(base.getTime());
        inicioData.setDate(inicioData.getDate() + offsetSegunda);
        const inicio = inicioData.getTime();
        const fim = inicio + (7 * 24 * 60 * 60 * 1000) - 1;
        return { inicio, fim };
    }

    if (periodo === "ano") {
        const inicioData = new Date(base.getFullYear(), 0, 1, 0, 0, 0, 0);
        const proximoAno = new Date(base.getFullYear() + 1, 0, 1, 0, 0, 0, 0);
        const inicio = inicioData.getTime();
        const fim = proximoAno.getTime() - 1;
        return { inicio, fim };
    }

    const inicioData = new Date(base.getFullYear(), base.getMonth(), 1, 0, 0, 0, 0);
    const proximoMes = new Date(base.getFullYear(), base.getMonth() + 1, 1, 0, 0, 0, 0);
    const inicio = inicioData.getTime();
    const fim = proximoMes.getTime() - 1;
    return { inicio, fim };
}

function formatarPeriodoDescricao(periodo, inicio, fim) {
    const fmt = (ts) => new Date(ts).toLocaleDateString("pt-BR");
    if (periodo === "dia") return fmt(inicio);
    if (periodo === "semana") return `${fmt(inicio)} a ${fmt(fim)}`;
    if (periodo === "ano") return `${new Date(inicio).getFullYear()}`;
    return `${new Date(inicio).toLocaleString("pt-BR", { month: "long", year: "numeric" })}`;
}

function alternarGraficoProducao() {
    const el = document.getElementById("graficoProducaoContainer");
    if (!el) return;
    if (el.style.display === "none" || el.style.display === "") {
        el.style.display = "block";
        renderizarGraficoProducao();
    } else {
        el.style.display = "none";
    }
}

function normalizarNomeProducao(nomeBruto) {
    const nome = String(nomeBruto || "").trim();
    if (!nome) return "S/DADOS";

    const chave = nome.toUpperCase().replace(/\s+/g, " ").trim();

    if (/^(BRUNO|BRUNO GASTON)$/.test(chave)) return "BRUNO";
    if (/^(FIGUEIREDO|LEO FIGUEIREDO|LEO)$/.test(chave)) return "FIGUEIREDO";
    if (/^FABIANO$/.test(chave)) return "FABIANO";
    if (/^(LEONARDO|LEONARDO ASS|LEONARDO ASSUNCAO|LEONARDO ASSUNÇÃO|LEONARDO ASSUNÃ§Ã£O)$/.test(chave)) return "LEONARDO ASSUNÇÃO";
    if (/^(PAULO|PAULO|PÃULO)$/.test(chave)) return "PAULO";
    if (/^(JOSE|JOSÉ)$/.test(chave)) return "JOSE";
    if (/^ADRIANO$/.test(chave)) return "ADRIANO";
    if (/^(JOAO|JOÃO|JOÃƒO|JOÃ£O)$/.test(chave)) return "JOAO";
    if (/^(JUNIOR|JR|JUNIRO|JÃºNIOR|JÃšNIOR)$/.test(chave)) return "JUNIOR";
    if (/^S\/DADOS$/.test(chave)) return "S/DADOS";

    return "S/DADOS";
}

function renderizarGraficoProducao() {
    const container = document.getElementById("graficoProducaoContainer");
    if (!container) return;

    const periodo = filtroProducaoAtual.periodo || "mes";
    const referencia = filtroProducaoAtual.referencia || new Date().toISOString().slice(0, 10);
    const { inicio, fim } = intervaloProducao(periodo, referencia);

    const impressoMap = new Map();
    const separadoMap = new Map();
    const conferenteMap = new Map();
    const finalizadosSet = new Set();

    const basePedidos = [...historicoFinalizados, ...pedidos];
    basePedidos.forEach(p => {
        (p.historico || []).forEach(h => {
            if (!h.acao) return;
            const ts = toTimestampSeguro(h.hora);
            if (!ts || ts < inicio || ts > fim) return;

            if (h.acao.includes("Impresso por ")) {
                const nome = normalizarNomeProducao(h.acao.replace("Impresso por ", "").trim());
                if (nome) impressoMap.set(nome, (impressoMap.get(nome) || 0) + 1);
            } else if (h.acao.includes("Separado por ")) {
                const nome = normalizarNomeProducao(h.acao.replace("Separado por ", "").trim());
                if (nome) separadoMap.set(nome, (separadoMap.get(nome) || 0) + 1);
            } else if (h.acao.includes("Retirado por ") && h.acao.includes(", conferido por ")) {
                const partes = h.acao.split(", conferido por ");
                const conferente = normalizarNomeProducao((partes[1] || "").trim());
                if (conferente) conferenteMap.set(conferente, (conferenteMap.get(conferente) || 0) + 1);
                finalizadosSet.add(`${p.tipo || ""}-${p.numero || ""}`);
            }
        });
    });

    const ordenar = (mapa) => Array.from(mapa.entries()).sort((a,b) => b[1] - a[1] || a[0].localeCompare(b[0]));

    const totalImp = Array.from(impressoMap.values()).reduce((acc, n) => acc + n, 0);
    const totalSep = Array.from(separadoMap.values()).reduce((acc, n) => acc + n, 0);
    const totalConf = Array.from(conferenteMap.values()).reduce((acc, n) => acc + n, 0);
    const totalEtapas = totalImp + totalSep + totalConf;
    const periodoDescricao = formatarPeriodoDescricao(periodo, inicio, fim);
    const pct = (valor, total) => total > 0 ? ((valor * 100) / total).toFixed(1) : "0.0";

    const renderGrafico = (titulo, lista, cor, totalEtapa) => {
        if (!lista.length) {
            return `<div style=\"margin:12px 0;\"><div style=\"font-weight:bold; margin-bottom:6px;\">${titulo}</div><div style=\"padding:14px; border:1px solid #ddd; border-radius:8px; background:#fff; color:#666;\">Sem dados no periodo selecionado.</div></div>`;
        }
        const max = Math.max(1, ...lista.map(x => x[1]));
        let html = `<div style=\"margin:12px 0;\">`;
        html += `<div style=\"font-weight:bold; margin-bottom:6px;\">${titulo}</div>`;
        html += `<div style=\"display:flex; align-items:flex-end; gap:10px; overflow-x:auto; padding:6px 2px; border:1px solid #ddd; border-radius:8px; background:#fff;\">`;
        lista.forEach(([nome, qtd]) => {
            const h = Math.round((qtd / max) * 160) + 20;
            const perc = pct(qtd, totalEtapa);
            html += `
                <div style=\"display:flex; flex-direction:column; align-items:center; min-width:70px;\">
                    <div style=\"font-size:12px; margin-bottom:4px;\">${qtd} (${perc}%)</div>
                    <div style=\"width:40px; height:${h}px; background:${cor}; border-radius:6px;\"></div>
                    <div style=\"font-size:11px; margin-top:6px; text-align:center;\">${nome}</div>
                </div>
            `;
        });
        html += `</div></div>`;
        return html;
    };

    const listaImp = ordenar(impressoMap);
    const listaSep = ordenar(separadoMap);
    const listaConf = ordenar(conferenteMap);

    container.innerHTML = `
        <div style="display:flex; flex-wrap:wrap; gap:10px; align-items:flex-end; background:#fff; border:1px solid #d9dce8; border-radius:10px; padding:10px; margin-bottom:10px;">
            <div style="min-width:160px; flex:1;">
                <label style="display:block; font-weight:bold; margin-bottom:4px; color:#1f2747;">Periodo</label>
                <select id="filtroProducaoPeriodo" style="margin:0; width:100%; padding:10px; border:1px solid #b8c0e3; border-radius:8px;">
                    <option value="dia" ${periodo === "dia" ? "selected" : ""}>Dia</option>
                    <option value="semana" ${periodo === "semana" ? "selected" : ""}>Semana</option>
                    <option value="mes" ${periodo === "mes" ? "selected" : ""}>Mes</option>
                    <option value="ano" ${periodo === "ano" ? "selected" : ""}>Ano</option>
                </select>
            </div>
            <div style="min-width:160px; flex:1;">
                <label style="display:block; font-weight:bold; margin-bottom:4px; color:#1f2747;">Data de referencia</label>
                <input id="filtroProducaoData" type="date" value="${referencia}" style="margin:0; width:100%; padding:9px; border:1px solid #b8c0e3; border-radius:8px;">
            </div>
            <div style="min-width:180px; flex:2; color:#344068; font-weight:bold; padding-bottom:8px;">
                Intervalo: ${periodoDescricao}
            </div>
        </div>

        <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(140px, 1fr)); gap:10px; margin-bottom:12px;">
            <div style="background:#ffffff; border:1px solid #d9dce8; border-radius:10px; padding:10px;">
                <div style="font-size:12px; color:#5c678f;">Impressao</div>
                <div style="font-size:28px; font-weight:bold; color:#ff8c00;">${totalImp}</div>
                <div style="font-size:12px; color:#5c678f;">${pct(totalImp, totalEtapas)}%</div>
            </div>
            <div style="background:#ffffff; border:1px solid #d9dce8; border-radius:10px; padding:10px;">
                <div style="font-size:12px; color:#5c678f;">Separacao</div>
                <div style="font-size:28px; font-weight:bold; color:#c29200;">${totalSep}</div>
                <div style="font-size:12px; color:#5c678f;">${pct(totalSep, totalEtapas)}%</div>
            </div>
            <div style="background:#ffffff; border:1px solid #d9dce8; border-radius:10px; padding:10px;">
                <div style="font-size:12px; color:#5c678f;">Conferencia</div>
                <div style="font-size:28px; font-weight:bold; color:#1e6fcf;">${totalConf}</div>
                <div style="font-size:12px; color:#5c678f;">${pct(totalConf, totalEtapas)}%</div>
            </div>
            <div style="background:#ffffff; border:1px solid #d9dce8; border-radius:10px; padding:10px;">
                <div style="font-size:12px; color:#5c678f;">Finalizados</div>
                <div style="font-size:28px; font-weight:bold; color:#2b6a2b;">${finalizadosSet.size}</div>
                <div style="font-size:12px; color:#5c678f;">${pct(finalizadosSet.size, totalConf)}% da conferencia</div>
            </div>
            <div style="background:#ffffff; border:1px solid #d9dce8; border-radius:10px; padding:10px;">
                <div style="font-size:12px; color:#5c678f;">Total Etapas</div>
                <div style="font-size:28px; font-weight:bold; color:#353d61;">${totalEtapas}</div>
                <div style="font-size:12px; color:#5c678f;">100%</div>
            </div>
        </div>

        ${renderGrafico("Impressao", listaImp, "#ff8c00", totalImp)}
        ${renderGrafico("Separacao", listaSep, "#ffc800", totalSep)}
        ${renderGrafico("Conferencia", listaConf, "#369aff", totalConf)}
    `;

    const selPeriodo = document.getElementById("filtroProducaoPeriodo");
    const inputData = document.getElementById("filtroProducaoData");
    if (selPeriodo) {
        selPeriodo.onchange = function() {
            filtroProducaoAtual.periodo = this.value;
            renderizarGraficoProducao();
        };
    }
    if (inputData) {
        inputData.onchange = function() {
            if (!this.value) return;
            filtroProducaoAtual.referencia = this.value;
            renderizarGraficoProducao();
        };
    }
}
function abrirHistorico(){
    abrirModal(); 
    document.getElementById("modalTitulo").innerText="Historico de Finalizados";
    document.getElementById("campoHistorico").classList.remove("hidden");

    const busca = document.getElementById("buscaHistorico");
    const listaEl = document.getElementById("listaHistorico");
    const btnExportar = document.getElementById("btnExportarHistorico");
    const btnDados = document.getElementById("btnDadosProducao");
    const graficoEl = document.getElementById("graficoProducaoContainer");
    if (busca) busca.style.display = "block";
    if (listaEl) listaEl.style.display = "block";
    if (btnExportar) btnExportar.style.display = "block";
    if (btnDados) btnDados.style.display = "block";
    if (graficoEl) graficoEl.style.display = "none";

    let div = document.getElementById("listaHistorico");
    div.innerHTML = "";

    if (historicoFinalizados.length === 0) {
        div.innerHTML = "<p style='text-align:center; color:#666; padding:30px;'>Nenhum pedido no histórico ainda.</p>";
        return;
    }

    const tabela = document.createElement("div");
    tabela.className = "tabela-historico";

    const cabecalho = document.createElement("div");
    cabecalho.className = "tabela-cabecalho";
    cabecalho.innerHTML = `<div>Tipo</div><div>Número</div><div>Cliente</div><div>Data Finalização</div>`;
    tabela.appendChild(cabecalho);

    historicoFinalizados.forEach(p => {
        const linha = document.createElement("div");
        linha.className = "tabela-linha";

        const ultima = p.historico[p.historico.length - 1];
        const dataFinal = new Date(ultima ? ultima.hora : Date.now()).toLocaleString("pt-BR");

        linha.innerHTML = `
            <div><strong>${p.tipo}</strong></div>
            <div><strong>${p.numero}</strong></div>
            <div>${p.nome}<br><small>Vendedor: ${p.vendedor || "-"}</small></div>
            <div>${dataFinal}</div>
        `;

        const detalhes = document.createElement("div");
        detalhes.className = "tabela-detalhes";
        detalhes.innerHTML = p.historico.map(h => `• ${h.acao} — ${new Date(h.hora).toLocaleString("pt-BR")}<br>`).join("");
        linha.appendChild(detalhes);
        tabela.appendChild(linha);
    });

    div.appendChild(tabela);

    document.getElementById("buscaHistorico").oninput = function() {
        let termo = this.value.toLowerCase().trim();
        tabela.querySelectorAll(".tabela-linha").forEach(linha => {
            linha.style.display = linha.textContent.toLowerCase().includes(termo) ? "contents" : "none";
        });
    };
}

function abrirPedidoFinalizado(numero) {
    let p = historicoFinalizados.find(x => x.numero === numero) || pedidos.find(x => x.numero === numero);
    if (!p) return;
    abrirModal();
    document.getElementById("modalTitulo").innerText = `${p.tipo} ${p.numero}`;
    const reentradaTag = p.reentrado
        ? '<div style="display:inline-block; margin:6px 0 10px; padding:4px 8px; background:#000; color:rgb(255, 136, 0); font-weight:bold; border-radius:4px; font-size:12px;">↪ REENTRADA</div><br>'
        : '';
    const instalacaoProxima = isInstalacaoProxima(p);
    const maisDe7Dias = isMaisDe7Dias(p);
    const precisaAlerta = instalacaoProxima || maisDe7Dias;
    let etiquetaAlerta = "";
    if (precisaAlerta) {
        let textoAlerta = instalacaoProxima && maisDe7Dias
            ? "ATENCAO"
            : (instalacaoProxima ? "INSTALACAO PROXIMA" : "MAIS DE 7 DIAS");
        let tituloAlerta = [];
        if (instalacaoProxima) tituloAlerta.push("Instalacao proxima");
        if (maisDe7Dias) tituloAlerta.push("Mais de 7 dias desde o cadastro");
        const classeEtiqueta = (instalacaoProxima && !maisDe7Dias) ? "etiqueta-alerta roxa" : "etiqueta-alerta";
        etiquetaAlerta = `<div class="${classeEtiqueta}" title="${tituloAlerta.join(' / ')}">${textoAlerta}</div>`;
    }
    document.getElementById("modalInfo").innerHTML = `${reentradaTag}${etiquetaAlerta}<b>${p.nome}</b><br>${p.vendedor || ''}<br>`;
    p.historico.forEach(h => {
        document.getElementById("modalInfo").innerHTML += `• ${h.acao} — ${new Date(h.hora).toLocaleString()}<br>`;
    });
}

function removerFinalizados() {
    const agora = Date.now();
    const TEMPO_LIMITE = 5 * 60 * 1000;

    let removidos = [];
    pedidos = pedidos.filter(p => {
        if (p.status === "finalizados" && p.finalizadoEm && (agora - p.finalizadoEm >= TEMPO_LIMITE)) {
            removidos.push(p);
            return false;
        }
        return true;
    });

    if (removidos.length > 0) {
        historicoFinalizados = historicoFinalizados.concat(removidos);
        salvarBanco();
        renderizar();
        atualizarContadores();
    }
}

function exportarHistoricoCSV() {
    if (historicoFinalizados.length === 0) return alert("O histórico está vazio!");

    let csv = "Tipo;Número;Cliente;Vendedor;Instalação;Hora Criação;Quem Imprimiu;Hora Impressão;Quem Separou;Hora Separação;Quem Retirou;Quem Conferiu;Hora Retirada\n";

    historicoFinalizados.sort((a,b) => {
        const ha = a.historico[a.historico.length-1]?.hora || 0;
        const hb = b.historico[b.historico.length-1]?.hora || 0;
        return hb - ha;
    }).forEach(p => {
        let cliente = (p.nome || "").replace(/[,;"]/g," ");
        let vendedor = (p.vendedor || "").replace(/[,;"]/g," ");
        let instalacao = (p.dataInstalacao || "").replace(/[,;"]/g," ");

        let hc="", hi="", qi="", hs="", qs="", hr="", qr="", qc="";
        p.historico.forEach(h => {
            const dt = new Date(h.hora).toLocaleString("pt-BR");
            if (h.acao.includes("Criado")) hc = dt;
            else if (h.acao.includes("Impresso por")) { qi = h.acao.replace("Impresso por ",""); hi = dt; }
            else if (h.acao.includes("Separado por")) { qs = h.acao.replace("Separado por ",""); hs = dt; }
            else if (h.acao.includes("Retirado por")) {
                const partes = h.acao.split(", conferido por ");
                qr = partes[0].replace("Retirado por ","");
                qc = partes[1] || "";
                hr = dt;
            }
        });

        csv += `${p.tipo};${p.numero};${cliente};${vendedor};${instalacao};${hc};${qi};${hi};${qs};${hs};${qr};${qc};${hr}\n`;
    });

    const blob = new Blob([csv], {type: 'text/csv;charset=utf-8;'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `historico_saba_${new Date().toISOString().slice(0,10)}.csv`;
    document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
}

/* Inicialização */
normalizarEquipeCadastro();
normalizarCredenciaisEquipe();
salvarBanco();
popularSelectOperadores();
renderizar();
atualizarContadores();
setInterval(removerFinalizados, 10000);
removerFinalizados();

document.addEventListener('keydown', e => { if (e.key === "Escape") fecharModal(); });
document.addEventListener("click", (e) => {
    const menu = document.getElementById("submenuAcoes");
    const botao = document.getElementById("btnMenuAcoes");
    if (!menu || !botao) return;
    if (menu.contains(e.target) || botao.contains(e.target)) return;
    menu.classList.add("hidden");
});

document.getElementById("pesquisaOSPV").addEventListener("keypress", e => { if (e.key === "Enter") pesquisarPedido(); });
document.getElementById("pesquisaOSPV").addEventListener("input", pesquisarPedido);

["numero","editNumero","numeroCancelar"].forEach(id => {
    const el = document.getElementById(id);
    el.addEventListener("keydown", apenasNumeros);
    el.addEventListener("input", () => limparNaoNumeros(el));
});

const inputSenha = document.getElementById("inputSenha");
if (inputSenha) {
    inputSenha.addEventListener("keydown", e => { if (e.key === "Enter") confirmarSenha(); });
}

function avisarSemConexaoComServidor() {
    const semDadosLocais = pedidos.length === 0 && historicoFinalizados.length === 0;
    const semSocket = !window.socket || !window.socket.connected;
    if (!semDadosLocais || !semSocket) return;

    alert("Sem conexao com o servidor SABA e sem dados locais. Inicie com 'node server.js' e acesse por http://IP_DA_MAQUINA:3000.");
}

setTimeout(avisarSemConexaoComServidor, 2500);

</script>
</body>
</html>
